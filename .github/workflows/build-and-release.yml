name: Release (macOS)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release_macos:
    runs-on: macos-15
    env:
      APP_NAME: AppleBooksExport
      BUNDLE_ID: com.applebooksexport.macos
      MACOS_MIN_VERSION: "14.0"
      ARCHES: "arm64 x86_64"
      CODESIGN_IDENTITY: ${{ vars.CODESIGN_IDENTITY }}
      NOTARY_PROFILE_NAME: ${{ vars.NOTARY_PROFILE_NAME }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.2'

      - name: Resolve Swift dependencies
        run: swift package resolve

      - name: Derive version from tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "MARKETING_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=$GITHUB_RUN_NUMBER" >> "$GITHUB_ENV"

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN=build.keychain
          CERT_PATH=cert.p12

          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > "$CERT_PATH" 2>/dev/null || \
            echo "$APPLE_CERTIFICATE_P12" | base64 -D > "$CERT_PATH"

          security create-keychain -p "" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security import "$CERT_PATH" -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN"
          rm "$CERT_PATH"

      - name: Configure notarytool credentials
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_B64: ${{ secrets.APPLE_API_PRIVATE_KEY_B64 }}
        run: |
          set -euo pipefail
          mkdir -p private_keys
          echo "$APPLE_API_PRIVATE_KEY_B64" | base64 --decode > private_keys/AuthKey.p8 2>/dev/null || \
            echo "$APPLE_API_PRIVATE_KEY_B64" | base64 -D > private_keys/AuthKey.p8
          xcrun notarytool store-credentials "$NOTARY_PROFILE_NAME" \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --key "private_keys/AuthKey.p8"

      - name: Build and sign app bundle
        env:
          APP_ENTITLEMENTS: ${{ github.workspace }}/entitlements.plist
        run: |
          set -euo pipefail
          Scripts/package_app.sh release

      - name: Create DMG
        run: |
          set -euo pipefail
          rm -rf dmg-staging AppleBooksExport.dmg
          mkdir -p dmg-staging
          cp -R AppleBooksExport.app dmg-staging/
          ln -s /Applications dmg-staging/Applications
          hdiutil create -volname "Apple Books Export" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            AppleBooksExport.dmg
          rm -rf dmg-staging

      - name: Sign DMG
        run: |
          set -euo pipefail
          codesign --force --timestamp --sign "$CODESIGN_IDENTITY" AppleBooksExport.dmg

      - name: Notarize and staple
        run: |
          set -euo pipefail
          xcrun notarytool submit AppleBooksExport.dmg \
            --keychain-profile "$NOTARY_PROFILE_NAME" \
            --wait
          xcrun stapler staple AppleBooksExport.dmg
          xcrun stapler validate AppleBooksExport.dmg

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          files: AppleBooksExport.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
