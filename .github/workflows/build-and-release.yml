name: Release (macOS)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release_macos:
    runs-on: macos-15
    env:
      APP_NAME: AppleBooksExport
      BUNDLE_ID: com.denyamsk.applebooksexportmac
      MACOS_MIN_VERSION: "14.0"
      ARCHES: "arm64 x86_64"
      CODESIGN_IDENTITY: ${{ vars.CODESIGN_IDENTITY }}
      APP_IDENTITY: ${{ vars.CODESIGN_IDENTITY }}
      NOTARY_PROFILE_NAME: ${{ vars.NOTARY_PROFILE_NAME }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Show toolchain versions
        run: |
          set -euo pipefail
          xcodebuild -version
          swift --version

      - name: Resolve Swift dependencies
        run: swift package resolve

      - name: Derive version
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "${VERSION:-}" ] || [ "$VERSION" = "$GITHUB_REF_NAME" ]; then
            VERSION_TAG=$(git describe --tags --abbrev=0 2>/dev/null || true)
            if [ -n "$VERSION_TAG" ]; then
              VERSION="${VERSION_TAG#v}"
            else
              VERSION="0.1.0"
            fi
          fi
          echo "MARKETING_VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER:-1}" >> "$GITHUB_ENV"

      - name: Import signing certificate
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN=build.keychain
          CERT_PATH=cert.p12

          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > "$CERT_PATH" 2>/dev/null || \
            echo "$APPLE_CERTIFICATE_P12" | base64 -D > "$CERT_PATH"

          security create-keychain -p "" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security import "$CERT_PATH" -k "$KEYCHAIN" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s "$KEYCHAIN"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN"
          rm "$CERT_PATH"

      - name: Verify signing identity
        run: |
          set -euo pipefail
          if [ -z "${CODESIGN_IDENTITY:-}" ]; then
            echo "CODESIGN_IDENTITY is not set (check GitHub Actions variables)." >&2
            exit 1
          fi
          if ! security find-identity -v -p codesigning | grep -F "$CODESIGN_IDENTITY" >/dev/null; then
            echo "Signing identity not found in keychain: $CODESIGN_IDENTITY" >&2
            security find-identity -v -p codesigning
            exit 1
          fi

      - name: Configure notarytool credentials
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          APPLE_API_PRIVATE_KEY_B64: ${{ secrets.APPLE_API_PRIVATE_KEY_B64 }}
        run: |
          set -euo pipefail
          mkdir -p private_keys
          echo "$APPLE_API_PRIVATE_KEY_B64" | base64 --decode > private_keys/AuthKey.p8 2>/dev/null || \
            echo "$APPLE_API_PRIVATE_KEY_B64" | base64 -D > private_keys/AuthKey.p8
          xcrun notarytool store-credentials "$NOTARY_PROFILE_NAME" \
            --key-id "$APPLE_API_KEY_ID" \
            --issuer "$APPLE_API_ISSUER_ID" \
            --key "private_keys/AuthKey.p8"

      - name: Build and sign app bundle
        env:
          APP_ENTITLEMENTS: ${{ github.workspace }}/entitlements.plist
        run: |
          set -euo pipefail
          Scripts/package_app.sh release

      - name: Verify app signature
        run: |
          set -euo pipefail
          codesign -dv --verbose=4 AppleBooksExport.app 2>&1 | tee codesign-app.txt
          if ! grep -F "Authority=$CODESIGN_IDENTITY" codesign-app.txt >/dev/null; then
            echo "Expected Developer ID authority not found." >&2
            exit 1
          fi
          if ! grep -F "Timestamp=" codesign-app.txt >/dev/null; then
            echo "Signature is missing a secure timestamp." >&2
            exit 1
          fi
          if ! grep -F "Runtime Version" codesign-app.txt >/dev/null; then
            echo "Hardened runtime not enabled." >&2
            exit 1
          fi
          codesign --verify --deep --strict --verbose=2 AppleBooksExport.app

      - name: Create DMG
        run: |
          set -euo pipefail
          rm -rf dmg-staging AppleBooksExport.dmg
          mkdir -p dmg-staging
          cp -R AppleBooksExport.app dmg-staging/
          ln -s /Applications dmg-staging/Applications
          hdiutil create -volname "Apple Books Export" \
            -srcfolder dmg-staging \
            -ov -format UDZO \
            AppleBooksExport.dmg
          rm -rf dmg-staging

      - name: Sign DMG
        run: |
          set -euo pipefail
          codesign --force --timestamp --sign "$CODESIGN_IDENTITY" AppleBooksExport.dmg

      - name: Notarize and staple
        run: |
          set -euo pipefail
          SUBMISSION_JSON=$(xcrun notarytool submit AppleBooksExport.dmg \
            --keychain-profile "$NOTARY_PROFILE_NAME" \
            --wait \
            --output-format json)
          SUBMISSION_ID=$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("id",""))' "$SUBMISSION_JSON")
          STATUS=$(python3 -c 'import json,sys; print(json.loads(sys.argv[1]).get("status",""))' "$SUBMISSION_JSON")
          if [ "$STATUS" != "Accepted" ]; then
            echo "Notarization failed with status: $STATUS" >&2
            if [ -n "$SUBMISSION_ID" ]; then
              xcrun notarytool log "$SUBMISSION_ID" \
                --keychain-profile "$NOTARY_PROFILE_NAME" || true
            fi
            exit 1
          fi
          xcrun stapler staple AppleBooksExport.dmg
          xcrun stapler validate AppleBooksExport.dmg

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          files: AppleBooksExport.dmg
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
